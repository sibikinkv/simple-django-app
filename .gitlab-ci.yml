stages:
    - build
    - deploy

workflow:
    rules:
        - if: '$CI_COMMIT_REF_NAME == "develop"'
          variables:
              IMAGE_TAG:  app_dev_$CI_COMMIT_SHORT_SHA
        - if: '$CI_COMMIT_REF_NAME == "master"'
          variables:
              IMAGE_TAG:  app_prod_$CI_COMMIT_SHORT_SHA


build_dev:
    stage: build
  
    image: docker:dind
  
    tags:
        - less2.1-runner-docker

    script:
        - docker build -t $CI_REGISTRY_IMAGE:$IMAGE_TAG django_blog
        - docker push $CI_REGISTRY_IMAGE:$IMAGE_TAG

    rules:
      - if: '$CI_COMMIT_REF_NAME == "develop"'
        when: always

run:
    stage: deploy
  
    tags:
        - less2.1-runner

    script:
        - docker-compose up -d
