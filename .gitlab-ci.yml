stages:
    - build
    - deploy
    - rollback

workflow:
    rules:
        - if: '$CI_COMMIT_REF_NAME == "develop"'
          variables:
              DEPLOY_PORT: 8001
              IMAGE_TAG:  app_dev_$CI_COMMIT_SHORT_SHA
        - if: '$CI_COMMIT_REF_NAME == "master"'
          variables:
              DEPLOY_PORT: 8000
              IMAGE_TAG:  app_prod_$CI_COMMIT_SHORT_SHA

build:
    stage: build
  
    image:
        name: gcr.io/kaniko-project/executor:v1.9.1-debug
        entrypoint: [""]
  
    tags:
        - less2.1-runner-docker

    script:
        # - docker build -t $CI_REGISTRY_IMAGE:$IMAGE_TAG django_blog
        - /kaniko/executor
          --context "${CI_PROJECT_DIR}/django_blog"
          --dockerfile "${CI_PROJECT_DIR}/django_blog/Dockerfile"
          --destination "${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}"
        # - docker run 
        #     -v $PWD/django_blog:/workspace
        #     -v ~/.docker/config.json:/kaniko/.docker/config.json:ro
        #     gcr.io/kaniko-project/executor:v0.15.0
        #     --dockerfile=Dockerfile
        #     --context=/workspace
        #     --destination=$CI_REGISTRY_IMAGE:$IMAGE_TAG
        # - docker push $CI_REGISTRY_IMAGE:$IMAGE_TAG

run:
    stage: deploy
  
    tags:
        - less2.1-runner

    script:
        - docker ps | grep $CI_REGISTRY_IMAGE | awk '{print $2}' | awk -F ":" '{print $2}' > previous_tag
        - docker-compose up -d

    artifacts:

        paths:
            - previous_tag


rollback:
    stage: rollback

    tags:
        - less2.1-runner

    rules:
        - when: manual
          allow_failure: true

    script:
        - export IMAGE_TAG=$(cat previous_tag)
        - docker-compose up -d
